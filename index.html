<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- metaphysics -->
    <meta charset="utf-8">
    <title>APS pay levels</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="keywords" content="act, canberra, aps, public, service, classifications, job, levels, titles">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- scripts -->
    <script src="./resources/d3.v7.min.js"></script>
    <link href="./resources/style.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <div id="container">
      <div></div>
      <div id="subhead">Select a job level:</div>
      <div id="selectorDiv">
        <select id="selector" onchange="changeLevel()"></select>
      </div>
      <svg id="chart">
        <g id="chartGroup"></g>
        <g id="axisGroup">
          <g id="xAxisGroup" class="axis"></g>
          <g id="yAxisGroup" class="axis"></g>
        </g>
      </svg>
      <div id="footer">Source: Public Service Commission</div>
    </div>

    <script>
      // elements
      container = d3.select("#container");
      subhead = d3.select("#subhead");
      selector = d3.select("#selector");
      chart = d3.select("#chart");
      chartGroup = d3.select("#chartGroup");
      axisGroup = d3.select("#axisGroup");
      xAxisGroup = d3.select("#xAxisGroup");
      yAxisGroup = d3.select("#yAxisGroup");
      footer = d3.select("#footer");

      // load data
      Promise.all([
        d3.csv("./data/apsMinima.csv"),
        d3.csv("./data/apsPayData.csv")
      ]).then(function(data) {

          // format data
          keyData = data[0]
            .map(d => {
              d.minimums = +d.minimums;
              d.maximums = +d.maximums;
              return d;
            });

          payData = data[1]
            .map(d => {
              d.min = +d.min;
              d.max = +d.max;
              return d;
            });

          levels = keyData
            .map(d => d.level);
          agencies = Array.from(
            new Set(payData.map(d => d.key))
          );

          // await fonts
          document.fonts.onloadingdone = drawChart();
        });

      function drawChart() {        
        options = selector
          .selectAll("option")
            .data(levels)
          .enter().append("option")
            .property("value", d => d)
            .text(d => d);
        options.filter(d => d == "EL1")
          .attr("selected", true);

        x = d3.scaleLinear();
        y = d3.scaleBand()
          .paddingInner(.1)
          .paddingOuter(0);

        xAxis = d3.axisTop(x)
          .ticks(2, "$,.0f")
          .tickSizeOuter(0);
        yAxis = d3.axisLeft(y)
          .tickSize(0);
        
        window.addEventListener("resize", resize);
        changeLevel();
      }
      
      function changeLevel() {        
        level = selector
          .property("value");

        chartData = payData
          .filter(d => d.level == level);

        x.domain([
          d3.min(chartData, d => d.min),
          d3.max(chartData, d => d.max)
        ]).nice();

        y.domain(chartData
          .sort((a, b) => d3.ascending(a.min, b.min))
          .map(d => d.key)
        );

        workplaces = chartGroup
          .selectAll(".workplace")
            .data(chartData, d => d.key);

        workplacesEnter = workplaces
          .enter().append("g")
            .classed("workplace", true);

        workplacesEnter.append("rect")
          .attr("width", 0);

        workplacesExit = workplaces.exit();
        
        resize();
      }

      function resize() {
        dimensions = document
          .getElementById("chart")
          .getBoundingClientRect();
        width = dimensions.width;

        loop = 1000;

        mobile = width <= 500;
        margin = mobile ?
          { top: 20, right: 15, bottom: 0, left: 130 } :
          { top: 25, right: 15, bottom: 0, left: 140 };          
        
        height = margin.top + margin.bottom + agencies.length * (mobile ? 20 : 25);

        // set chart height
        chart.style("height", height + "px");
        iframeHeight = document.getElementById("container").getBoundingClientRect().height;

        // send dimensions to host window
        window.parent.postMessage({
          sentinel: "amp",
          type: "embed-size",
          height: iframeHeight
        }, "*");

        // redraw chart
        x.range([margin.left, width - margin.right]);
        xAxis.tickPadding(mobile ? 10 : 10)
          .tickSizeInner(margin.top + margin.bottom - height);

        y.range([margin.top, height - margin.bottom]);
        yAxis.tickPadding(mobile ? 10 : 10);

        xAxisGroup.attr("transform", "translate(0, " + margin.top + ")")
          .transition()
            .duration(loop)
            .call(xAxis);

        yAxisGroup.attr("transform", "translate(" + margin.left + ", 0)")
          .transition()
            .duration(loop)
            .call(yAxis);

        workplacesExit.transition()
          .duration(loop)
          .style("opacity", 0)
          .remove();

        workplacesEnter.attr("transform", d => "translate(0, " + y(d.key) + ")");
        workplacesEnter.select("rect")
          .attr("height", y.bandwidth())
          .attr("x", d => x(d.min))
          .transition()
            .duration(loop)
            .attr("width", d => Math.max(x(d.max) - x(d.min), 2));
        
        workplaces.transition()
          .duration(loop)
          .attr("transform", d => "translate(0, " + y(d.key) + ")");
        workplaces.select("rect")
          .transition()
            .duration(loop)
            .attr("height", y.bandwidth())
            .attr("x", d => x(d.min))
            .attr("width", d => Math.max(x(d.max) - x(d.min), 2));
      }
    </script>
  </body>
</html>
